<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tirage d√©partements + Nimbo (s√©lecteur mois/ann√©e en contr√¥le Leaflet)</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
  <style>
    :root{
      --bg:#0b1020; --panel:#111827; --panel-2:#1f2937; --text:#e5e7eb; --muted:#9ca3af;
      --green:#22c55e; --green-dark:#16a34a; --accent:#60a5fa; --danger:#ef4444; --border:#374151;
    }
    html, body { height: 100%; margin: 0; background: var(--bg); color: var(--text); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial; }
    #app { position: relative; height: 100%; }
    #map { position:absolute; inset:0; }

    /* Panneau de contr√¥le gauche (tirage) */
    .controls { position: absolute; top: 16px; left: 16px; z-index: 1000; display: flex; flex-direction: column; gap: 12px; width: 340px; max-width: calc(100vw - 32px); }
    .card { background: linear-gradient(180deg, var(--panel), var(--panel-2)); border: 1px solid var(--border); border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.35); overflow: hidden; }
    .card h2 { margin: 0; padding: 14px 16px; font-size: 16px; letter-spacing: .3px; background: rgba(255,255,255,0.03); border-bottom: 1px solid var(--border); color: #fff; display:flex; align-items:center; gap:8px; }
    .card h2 .dot{ width:10px;height:10px;border-radius:999px;background:var(--accent); box-shadow:0 0 10px var(--accent); }
    .card .content { padding: 12px; }

    .btn-row { display: flex; gap: 8px; }
    button { appearance: none; border: 1px solid var(--border); color: #fff; background: #0b1222; padding: 10px 12px; border-radius: 12px; cursor: pointer; font-weight: 600; letter-spacing:.2px; transition: transform .08s ease, background .2s ease, border-color .2s ease; flex: 1 1 auto; }
    button:hover { transform: translateY(-1px); background: #0f172a; }
    button:active { transform: translateY(0); }
    button[disabled]{ opacity:.6; cursor: not-allowed; }
    .btn-primary{ background: linear-gradient(180deg, var(--green), var(--green-dark)); border-color: rgba(0,0,0,.2); }
    .btn-primary:hover{ filter: brightness(1.05); }
    .btn-reset{ background: linear-gradient(180deg, #f87171, var(--danger)); }

    .picked-list { display: grid; grid-template-columns: 1fr; gap: 6px; max-height: 220px; overflow: auto; }
    .pill { display:flex; align-items:center; justify-content:space-between; gap:8px; background: #0c1426; border:1px solid var(--border); padding: 8px 10px; border-radius: 10px; font-size: 13px; }
    .pill .code { color: var(--muted); font-variant-numeric: tabular-nums; }

    .hint { font-size: 12px; color: var(--muted); margin-top: 6px; }

    /* Leaflet overrides (dark) */
    .leaflet-container { background: #0b0f1a; }
    .leaflet-control { border-color: var(--border) !important; }
    .leaflet-control-zoom a, .leaflet-control-layers-toggle { background:#0b1222; border-color: var(--border); color:#fff; }
    .leaflet-control-zoom a:hover { background:#0f172a; }
    .leaflet-control-layers { background: linear-gradient(180deg, var(--panel), var(--panel-2)); color:#fff; border:1px solid var(--border); }
    .leaflet-control-layers label { color:#e5e7eb; }

    /* Effet s√©lection finale */
    @keyframes pulse { 0% { filter: drop-shadow(0 0 0 rgba(34,197,94,0)); } 50% { filter: drop-shadow(0 0 10px rgba(34,197,94,.8)); } 100% { filter: drop-shadow(0 0 0 rgba(34,197,94,0)); } }
    .final-pulse { animation: pulse 1.2s ease-in-out -3; }
  </style>
</head>
<body>
  <div id="app">
    <div id="map"></div>

    <!-- Panneau gauche: tirage -->
    <div class="controls">
      <div class="card">
        <h2><span class="dot"></span> Tirage al√©atoire des d√©partements</h2>
        <div class="content">
          <div class="btn-row">
            <button id="drawBtn" class="btn-primary">üé≤ Lancer le tirage (6 s)</button>
            <button id="resetBtn" class="btn-reset">‚Ü∫ Reset</button>
          </div>
          <div id="status" class="hint">Pr√™t.</div>
        </div>
      </div>
      <div class="card">
        <h2 style="font-size:14px;">D√©partements d√©j√† tir√©s</h2>
        <div class="content">
          <div id="picked" class="picked-list" aria-live="polite"></div>
          <div class="hint">Ces d√©partements seront exclus des tirages suivants.</div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <script>
  (function(){
    const GEOJSON_URL = "https://france-geojson.gregoiredavid.fr/repo/departements.geojson"; // propri√©t√©s: code, nom
    const apiKey = '<YOUR_API_KEY>'; // remplac√© au d√©ploiement (Option A)

    // --- √âtat ---
    const state = {
      layersByCode: new Map(),
      features: [],
      drawnCodes: new Set(JSON.parse(localStorage.getItem('drawnCodes')||'[]')),
      flashingLayer: null,
      finalLayer: null,
      spinning: false,
    };

    // --- Carte ---
    const map = L.map('map', { zoomControl: false }).setView([46.6, 2.5], 6);
    const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png');
    const layerControl = L.control.layers({}, {}, { position:'topright' }).addTo(map);
    L.control.zoom({ position: 'bottomright' }).addTo(map);
    layerControl.addBaseLayer(osm, 'OSM');

    // === Contr√¥le Leaflet custom pour s√©lectionner Ann√©e/Mois ===
    const DateControl = L.Control.extend({
      options: { position: 'topright' },
      onAdd: function(){
        const container = L.DomUtil.create('div', 'leaflet-control leaflet-bar');
        container.style.padding = '8px';
        container.style.background = 'linear-gradient(180deg, #111827, #1f2937)';
        container.style.border = '1px solid var(--border)';
        container.style.borderRadius = '8px';
        container.style.color = '#e5e7eb';
        container.style.minWidth = '180px';
        container.title = 'Basemap Nimbo ‚Äî choisir mois/ann√©e';

        const label = document.createElement('div');
        label.textContent = 'Nimbo';
        label.style.fontWeight = '700';
        label.style.fontSize = '12px';
        label.style.marginBottom = '6px';
        label.style.color = '#e5e7eb';

        const row = document.createElement('div');
        row.style.display = 'flex';
        row.style.gap = '6px';

        const year = document.createElement('input');
        year.type = 'number'; year.id = 'yearSelect'; year.min = '2020'; year.max = '2035'; year.value = new Date().getFullYear();
        Object.assign(year.style, { background:'#0b1222', color:'#fff', border:'1px solid #374151', borderRadius:'6px', padding:'6px 8px', width:'84px', fontWeight:'700' });
        year.setAttribute('aria-label','Ann√©e');

        const month = document.createElement('select');
        month.id = 'monthSelect';
        const months = ['Jan','F√©v','Mar','Avr','Mai','Juin','Juil','Ao√ªt','Sep','Oct','Nov','D√©c'];
        months.forEach((m, i) => { const opt = document.createElement('option'); opt.value = (i+1); opt.textContent = m; month.appendChild(opt); });
        month.value = String(new Date().getMonth() - 1);
        Object.assign(month.style, { background:'#0b1222', color:'#fff', border:'1px solid #374151', borderRadius:'6px', padding:'6px 8px', fontWeight:'700' });
        month.setAttribute('aria-label','Mois');

        row.appendChild(year); row.appendChild(month);
        container.appendChild(label); container.appendChild(row);

        // Emp√™che le drag/zoom quand on manipule les inputs
        L.DomEvent.disableClickPropagation(container);
        L.DomEvent.disableScrollPropagation(container);

        // Events branch√©s sur l'update du fond Nimbo
        container.addEventListener('change', updateNimboLayer);

        return container;
      }
    });
    const dateControl = new DateControl();
    map.addControl(dateControl);

    // === Nimbo dynamique ===
    let nimboLayer = null;
    function monthName(n){ return [,'Janvier','F√©vrier','Mars','Avril','Mai','Juin','Juillet','Ao√ªt','Septembre','Octobre','Novembre','D√©cembre'][Number(n)] || String(n); }
   function updateNimboLayer(){
    const year = document.getElementById('yearSelect').value;
    const month = document.getElementById('monthSelect').value;
    const version = 1;
  
    // Si la couche attend un mois sur 2 chiffres, d√©commente la ligne suivante
    // const mm = String(month).padStart(2, '0');
    // const layerName = `${year}_${mm}_${version}@kermap`;
    const layerName = `${year}_${month}_${version}@kermap`;
  
    if (nimboLayer) {
      map.removeLayer(nimboLayer);
      try { layerControl.removeLayer(nimboLayer); } catch(e){}
    }
  
    nimboLayer = L.tileLayer(
      `https://proxybingo.netlify.app/tiles/2025_6_1@kermap/{z}/{x}/{y}.png`,
      { tms: true, maxZoom: 19, attribution: '¬© Kermap / Nimbo' }
    );
    nimboLayer.addTo(map);
    layerControl.addBaseLayer(nimboLayer, `Nimbo ${monthName(month)} ${year}`);
    }
    
    // Au moment de cr√©er le select "month", choisis une valeur valide :
    const m0 = new Date().getMonth();           // 0..11
    const prev = ((m0 + 11) % 12) + 1;          // 1..12 (mois pr√©c√©dent)
    month.value = String(prev);

    //nimboLayer = L.tileLayer(
    //  `https://prod-data.nimbo.earth/mapcache/tms/1.0.0/${layerName}/{z}/{x}/{-y}.png?kermap_token=${apiKey}`,
    //  { tms:true, tileSize:256, maxZoom:19, attribution: '¬© Kermap / Nimbo ¬∑ Donn√©es ¬© contributeurs' }
    //);

    // Initialise Nimbo une premi√®re fois (apr√®s cr√©ation du contr√¥le)
    updateNimboLayer();

    // --- Styles des d√©partements ---
    const baseStyle = { color: '#e9eef2', weight: 1, fillColor: '#0e172a', fillOpacity: 0.55 };
    const hoverStyle = { weight: 2, color: '#93c5fd' };
    const flashStyle = { fillColor: randomHexColor(), fillOpacity: 0.95 };
    const drawnStyle = { fillColor: '#6b7280', fillOpacity: 0.5 };
    const finalStyle = { fillColor: '#22c55e', fillOpacity: 0.95 };

    // --- UI tirage ---
    const drawBtn = document.getElementById('drawBtn');
    const resetBtn = document.getElementById('resetBtn');
    const pickedEl = document.getElementById('picked');
    const statusEl = document.getElementById('status');

    function setStatus(text){ statusEl.textContent = text; }
    function saveDrawn(){ localStorage.setItem('drawnCodes', JSON.stringify([...state.drawnCodes])); }
    function renderPicked(){
      const items = [...state.drawnCodes].map(code => {
        const f = state.features.find(ft => ft.properties.code === code);
        const name = f ? f.properties.nom : code;
        return `<div class="pill"><span>${name}</span><span class="code">${code}</span></div>`;
      });
      pickedEl.innerHTML = items.join('') || '<div class="hint">Aucun pour l\'instant.</div>';
    }

    function styleFor(layer){ const code = layer.feature.properties.code; return state.drawnCodes.has(code) ? { ...baseStyle, ...drawnStyle } : baseStyle; }
    function applyStyles(){ state.layersByCode.forEach(layer => layer.setStyle(styleFor(layer))); }
    function clearFlash(){ if(state.flashingLayer){ state.flashingLayer.setStyle(styleFor(state.flashingLayer)); state.flashingLayer = null; } }
    function clearFinalPulse(){ if(state.finalLayer){ const el = state.finalLayer.getElement(); if(el) el.classList.remove('final-pulse'); } }
    function setFinal(layer){ clearFlash(); clearFinalPulse(); state.finalLayer = layer; layer.setStyle({ ...baseStyle, ...finalStyle }); const el = layer.getElement(); if(el){ el.classList.add('final-pulse'); } }
    function availableCodes(){ return state.features.map(f => f.properties.code).filter(c => !state.drawnCodes.has(c)); }
    function pickRandom(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
    function layerByCode(code){ return state.layersByCode.get(code); }
    function flashLayer(layer){ if(!layer) return; clearFlash(); state.flashingLayer = layer; layer.setStyle({ ...baseStyle, ...flashStyle }); }
    function randomHexColor(){ return "#" + Math.floor(Math.random()*0xffffff).toString(16).padStart(6,'0').toUpperCase(); }
    function easeInQuad(t){ return t*t; }

    async function spinAndPick(){
      if(state.spinning) return;
      const avail = availableCodes();
      if(avail.length === 0){ setStatus('Tous les d√©partements ont √©t√© tir√©s. Utilisez Reset pour recommencer.'); return; }
      state.spinning = true; drawBtn.disabled = true; resetBtn.disabled = true; setStatus('Tirage en cours‚Ä¶');
      const duration = 6000; const steps = Math.min(40, Math.max(18, Math.floor(avail.length * 0.6)));
      const times = []; for(let i=0;i<steps;i++){ const t=(i+1)/steps; times.push(Math.round(easeInQuad(t)*duration)); }
      const deltas = [times[0]]; for(let i=1;i<times.length;i++) deltas.push(times[i]-times[i-1]);
      for(let i=0;i<steps;i++){ await new Promise(res => setTimeout(res, deltas[i])); const code=pickRandom(avail); flashLayer(layerByCode(code)); }
      const finalCode = pickRandom(avail); const finalLayer = layerByCode(finalCode);
      setFinal(finalLayer); state.drawnCodes.add(finalCode); saveDrawn(); renderPicked(); applyStyles();
      setStatus(`Tirage termin√© ‚Üí ${finalLayer.feature.properties.nom} (${finalCode})`);
      state.spinning = false; drawBtn.disabled = false; resetBtn.disabled = false;
    }

    drawBtn.addEventListener('click', spinAndPick);
    resetBtn.addEventListener('click', () => { if(state.spinning) return; state.drawnCodes.clear(); saveDrawn(); renderPicked(); applyStyles(); clearFlash(); clearFinalPulse(); setStatus('R√©initialis√©. Pr√™t.'); });

    // Charger le GeoJSON
    fetch(GEOJSON_URL).then(r => r.json()).then(geo => {
      state.features = geo.features;
      const layer = L.geoJSON(geo, {
        style: () => baseStyle,
        onEachFeature: (feature, lyr) => {
          const code = feature.properties.code;
          state.layersByCode.set(code, lyr);
          lyr.bindTooltip(`${feature.properties.nom} (${code})`, { sticky: true });
          lyr.on('mouseover', () => { if(!state.spinning) lyr.setStyle({ ...styleFor(lyr), ...hoverStyle }); });
          lyr.on('mouseout', () => { if(!state.spinning) lyr.setStyle(styleFor(lyr)); });
        }
      }).addTo(map);
      map.fitBounds(layer.getBounds(), { padding: [20, 20] });
      renderPicked(); applyStyles(); setStatus('Carte charg√©e.');
    }).catch(err => { console.error(err); setStatus('Erreur de chargement de la carte. V√©rifiez votre connexion.'); });
  })();
  </script>
</body>
</html>






